name: Create GitHub Issue

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  create_issue:
    permissions:
      issues: write
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Upload Some Attachments
        id: upload_some_attachments
        uses: actions/upload-artifact@v4
        with:
          name: reports
          path: "**/reports/**"

      - name: Track failure with GitHub Issue
        # Don't add condition for testing purpose now.
        # if: failure()
        id: create-github-issue
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const issueTitle = "UI test failed";
            const issueBody = `
              See reports from failed UI tests in the attachments. [link](${{ steps.upload_some_attachments.outputs.artifact-url }})
            `;
            const labels = ["automated issue"];
            const issue = await github.rest.issues.create({
              owner,
              repo,
              title: issueTitle,
              body: issueBody,
              labels
            });
            console.log(`Created issue https://github.com/${owner}/${repo}/issues/${issue.data.number}`);
            return issue.data.number

      - name: Download failure artifacts
        uses: actions/download-artifact@v3
        with:
          name: reports
          path: ./artifacts

      - name: Unzip artifacts
        run: unzip ./artifacts/reports.zip -d ./artifacts

      - name: List files recursively
        # Need to make it platform independent
        run: ls -R ./artifacts
